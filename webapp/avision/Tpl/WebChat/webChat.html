<!--èŠå¤©æ˜¾ç¤ºå—-->
<div class="wechat-container">
<div id="chatMsg">
	{$messageList}
</div>
	{$isAdmin}
<div id="chat-bottom">
	<div id="newMsg" >
		<!--
		<div id="chatFunction" style="display:block;text-align:left;">

			<a href="javascript:;" class="easyui-linkbutton" data-options="height:20,width:160" onClick="$('#chatMsg').text('')">æ¸…å±</a>
			<a id='autoUpdate' href="javascript:;" class="easyui-linkbutton" data-options="width:80,height:20,toggle:true">è‡ªåŠ¨åˆ·æ–°</a>
			<span id="chatOptMsg" style="color:red;"></span>
				<if condition="$showfullurl neq ''">
				<a href="{$showfullurl}" target="_blank"><img src="/player/{$theme|default='default'}/images/full.png" style="margin-left:3px;cursor:pointer;vertical-align:middle;">
				</a>
				</if>
		</div>

		<div contenteditable="plaintext-only" style="max-height: 36px; overflow-y: auto;">qq</div>
		<div style="display:table-row;text-align:center;">
			<div style="display:table">
			<div style="display:table-cell;width:100%;padding:2px;">
				<input id="message" type="text" name="message" class="easyui-textbox" data-options="multiline:true,width:'100%',height:'40px'">
			</div>
			<div style="display:table-cell;width:1.3em;">
				<a id='sendBtn' href="javascript:void(0);" class="easyui-linkbutton"
					data-options="width:'60px',height:'40px',iconCls:'icon-send',iconAlign:'top', onClick:function(){ {$objName}.sendMsg();}"
					>å‘é€</a>
			</div>
			</div>
		</div>
		-->
		<if condition="$showfullurl neq ''">
			<!-- <div class="func-btn" func="full">ğŸ“„</div> å•é¡µæ˜¾ç¤ºæ ·å¼é—®é¢˜ï¼Œæš‚æ—¶åœç”¨-->
		</if>
		<div contenteditable="plaintext-only" class="input-box"></div>
		<div class="func-btn" func="emoji">â˜º</div>
		<!-- <div class="func-btn" func="gift">ğŸ</div> ç­‰å¾…å®ç°-->
		<div class="func-btn txt-btn" func="send">å‘é€</div>
	</div>
	<div id="emoji" class="popup-box">
		<ul>
			<li>ğŸ˜Š</li><li>ğŸ˜‰</li><li>ğŸ¤£</li><li>ğŸ˜‚</li><li>ğŸ˜</li>
			<li>ğŸ˜</li><li>ğŸ˜¡</li><li>ğŸ¤¬</li><li>ğŸ˜¤</li><li>ğŸ˜±</li>
			<li>ğŸ˜·</li><li>ğŸ¤§</li><li>ğŸ‘»</li><li>ğŸ‘</li><li>ğŸ™</li>
			<li>ğŸ§¡</li><li>ğŸ’”</li><li>ğŸ’ª</li><li>ğŸ‘Œ</li><li>ğŸ‘</li>
			<li>ğŸ‘Š</li><li>ğŸ¶</li><li>ğŸŒ</li><li>ğŸ»</li><li>ğŸš—</li>
			<li>ğŸš²</li><li>ğŸ¡</li><li>ğŸš€</li><li>ğŸ’‹</li><li>ğŸ™‰</li>
		</ul>
	</div>
	<div id="gift-list" class="popup-box">
		ç¤¼ç‰©ï¼Œè¿˜æœªè§£é”
	</div>
</div>
</div>
<script type="text/javascript">

	/* æ–°æ¶ˆæ¯ç›¸å…³åŠŸèƒ½æŒ‰é’® */
	$("#newMsg").on("click",function (event) {
		var obj=event.target;
		var func=$(obj).attr("func");
		switch (func){
			case "send":
                $("#chat-bottom .popup-box").hide('fast');
			    var msg=$("#newMsg .input-box").html();
			    //console.log(msg);
            	{$objName}.sendMsg(msg);
                $("#newMsg .input-box").html('');
			    break;
			case "full":
			    window.open("{$showfullurl}");
			    break;
			case "emoji":
                $("#chat-bottom .popup-box").not("#emoji").hide();
			    $("#emoji").toggle('normal');
                $("#newMsg .input-box").focus();

                var selection = getSelection()
                // åˆ¤æ–­æ˜¯å¦æœ‰æœ€åå…‰æ ‡å¯¹è±¡å­˜åœ¨
				if(typeof(lastEditRange)=='undefined'){
                    //console.log('uuu');
                    {$objName}.setLastEditRange();
				}

                if (lastEditRange) {
                    // å­˜åœ¨æœ€åå…‰æ ‡å¯¹è±¡ï¼Œé€‰å®šå¯¹è±¡æ¸…é™¤æ‰€æœ‰å…‰æ ‡å¹¶æ·»åŠ æœ€åå…‰æ ‡è¿˜åŸä¹‹å‰çš„çŠ¶æ€
                    selection.removeAllRanges()
                    selection.addRange(lastEditRange)
                }
			    break;
			case "gift":
                $("#chat-bottom .popup-box").not("#gift-list").hide();
                $("#gift-list").toggle('gift');
			    break;
		}
    });

    // å®šä¹‰æœ€åå…‰æ ‡å¯¹è±¡
    ///var lastEditRange;
    // ç¼–è¾‘æ¡†ç‚¹å‡»äº‹ä»¶,ç¼–è¾‘æ¡†æŒ‰é”®å¼¹èµ·äº‹ä»¶
    $("#newMsg .input-box").on("click keyup",function () {
        {$objName}.setLastEditRange();
        $("#emoji").hide('fast');
            return;
        // è·å–é€‰å®šå¯¹è±¡
        //var selection = getSelection()
        // è®¾ç½®æœ€åå…‰æ ‡å¯¹è±¡
        //lastEditRange = selection.getRangeAt(0)

    });


    /**
	 * åœ¨è¾“å…¥æ¡†å¯¹è±¡çš„å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬æˆ–HTMLè¯­å¥
     * @param string text	è¦æ’å…¥çš„æ–‡æœ¬
     * @param objiect edit	è¾“å…¥æ¡†å¯¹è±¡
     */
    /*
    function insertText(text, edit){
        var emojiInput={value:text};
        // ç¼–è¾‘æ¡†è®¾ç½®ç„¦ç‚¹
        edit.focus()
        // è·å–é€‰å®šå¯¹è±¡
        var selection = getSelection()
        // åˆ¤æ–­æ˜¯å¦æœ‰æœ€åå…‰æ ‡å¯¹è±¡å­˜åœ¨
        if (lastEditRange) {
            // å­˜åœ¨æœ€åå…‰æ ‡å¯¹è±¡ï¼Œé€‰å®šå¯¹è±¡æ¸…é™¤æ‰€æœ‰å…‰æ ‡å¹¶æ·»åŠ æœ€åå…‰æ ‡è¿˜åŸä¹‹å‰çš„çŠ¶æ€
            selection.removeAllRanges()
            selection.addRange(lastEditRange)
        }
        // åˆ¤æ–­é€‰å®šå¯¹è±¡èŒƒå›´æ˜¯ç¼–è¾‘æ¡†è¿˜æ˜¯æ–‡æœ¬èŠ‚ç‚¹
        //console.log(selection.anchorNode);
        if (selection.anchorNode.nodeName != '#text') {
            // å¦‚æœæ˜¯ç¼–è¾‘æ¡†èŒƒå›´ã€‚åˆ™åˆ›å»ºè¡¨æƒ…æ–‡æœ¬èŠ‚ç‚¹è¿›è¡Œæ’å…¥
            var emojiText = document.createTextNode(emojiInput.value)
             if (edit.childNodes.length > 0) {
                // å¦‚æœæ–‡æœ¬æ¡†çš„å­å…ƒç´ å¤§äº0ï¼Œåˆ™è¡¨ç¤ºæœ‰å…¶ä»–å…ƒç´ ï¼Œåˆ™æŒ‰ç…§ä½ç½®æ’å…¥è¡¨æƒ…èŠ‚ç‚¹
                for (var i = 0; i < edit.childNodes.length; i++) {
                    if (i == selection.anchorOffset) {
                        edit.insertBefore(emojiText, edit.childNodes[i])
                    }
                }
            } else {
                // å¦åˆ™ç›´æ¥æ’å…¥ä¸€ä¸ªè¡¨æƒ…å…ƒç´ 
                edit.appendChild(emojiText)
            }
            // åˆ›å»ºæ–°çš„å…‰æ ‡å¯¹è±¡
            var range = document.createRange()
            // å…‰æ ‡å¯¹è±¡çš„èŒƒå›´ç•Œå®šä¸ºæ–°å»ºçš„è¡¨æƒ…èŠ‚ç‚¹
            range.selectNodeContents(emojiText)
            // å…‰æ ‡ä½ç½®å®šä½åœ¨è¡¨æƒ…èŠ‚ç‚¹çš„æœ€å¤§é•¿åº¦
            range.setStart(emojiText, emojiText.length)
            // ä½¿å…‰æ ‡å¼€å§‹å’Œå…‰æ ‡ç»“æŸé‡å 
            range.collapse(true)
            // æ¸…é™¤é€‰å®šå¯¹è±¡çš„æ‰€æœ‰å…‰æ ‡å¯¹è±¡
            selection.removeAllRanges()
            // æ’å…¥æ–°çš„å…‰æ ‡å¯¹è±¡
            selection.addRange(range)
        } else {
            // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹åˆ™å…ˆè·å–å…‰æ ‡å¯¹è±¡
            var range = selection.getRangeAt(0)
            // è·å–å…‰æ ‡å¯¹è±¡çš„èŒƒå›´ç•Œå®šå¯¹è±¡ï¼Œä¸€èˆ¬å°±æ˜¯textNodeå¯¹è±¡
            var textNode = range.startContainer;
            // è·å–å…‰æ ‡ä½ç½®
            var rangeStartOffset = range.startOffset;
            // æ–‡æœ¬èŠ‚ç‚¹åœ¨å…‰æ ‡ä½ç½®å¤„æ’å…¥æ–°çš„è¡¨æƒ…å†…å®¹
            textNode.insertData(rangeStartOffset, emojiInput.value)
            // å…‰æ ‡ç§»åŠ¨åˆ°åˆ°åŸæ¥çš„ä½ç½®åŠ ä¸Šæ–°å†…å®¹çš„é•¿åº¦
            range.setStart(textNode, rangeStartOffset + emojiInput.value.length)
            // å…‰æ ‡å¼€å§‹å’Œå…‰æ ‡ç»“æŸé‡å 
            range.collapse(true)
            // æ¸…é™¤é€‰å®šå¯¹è±¡çš„æ‰€æœ‰å…‰æ ‡å¯¹è±¡
            selection.removeAllRanges()
            // æ’å…¥æ–°çš„å…‰æ ‡å¯¹è±¡
            selection.addRange(range)
        }
        // æ— è®ºå¦‚ä½•éƒ½è¦è®°å½•æœ€åå…‰æ ‡å¯¹è±¡
        lastEditRange = selection.getRangeAt(0)
    }
*/
    /* ç‚¹å‡»è¡¨æƒ…ç¬¦å· */
    $("#emoji ul").on("click",function (event) {
        var obj=event.target;
        //console.log(obj);
        //console.log(event.delegateTarget);
        if(obj==event.delegateTarget){
            //$("#emoji").hide('fast');
        }else {
            var str=$(obj).html();
            var inputBox=$("#newMsg .input-box")[0];
            {$objName}.insertText(str,inputBox);
        }
    });

    /* ç¦è¨€äº‹ä»¶*/
	$("#chatMsg .chat-item .left-box").on("click",function (event) {
		var obj=event.delegateTarget;
		var sender=$(obj).attr("sender");
		if(sender>0){
            $.messager.defaults = { ok: "ç¡®å®š", cancel: "å†æƒ³æƒ³" }
            $.messager.confirm('ç¡®è®¤','éœ€è¦ç¦æ­¢æ­¤è´¦å·å‘è¨€å—ï¼Ÿ',function (r) {
				if(r){
                    {$objName}.noChat(sender);
				}
            });
		}
    });
</script>